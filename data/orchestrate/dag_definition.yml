dags:
  daily_dashboard:
    interval: '0 10 * * *'
    steps:
      - name: mart_dbt
        cmd: 'meltano invoke dbt:run --models marts.*'
        retries: 2
      - name: mart_dbt_test
        cmd: 'meltano invoke dbt:test --models marts.*'
        retries: 2
        depends_on:
          - mart_dbt
  hub_metrics:
    interval: '0 10 * * *'
    steps:
      - name: dbt_hub_metrics
        cmd: 'meltano invoke dbt:run --models publish.meltano_hub.*'
        retries: 2
      - name: ge_consumption_validate
        cmd: 'meltano test great_expectations:test_dbt_hub_metrics'
        retries: 2
        depends_on:
          - dbt_hub_metrics
      - name: publish_hub_metrics
        cmd: 'meltano elt tap-athena-metrics target-yaml-metrics && meltano invoke awscli s3 cp metrics.yml s3://prod-meltano-bucket-01/hub_metrics/'
        retries: 2
        depends_on:
          - ge_consumption_validate
      - name: publish_audit
        cmd: 'meltano elt tap-athena-audit target-yaml-audit && meltano invoke awscli s3 cp audit.yml s3://prod-meltano-bucket-01/hub_metrics/'
        retries: 2
        depends_on:
          - ge_consumption_validate
  google_analytics:
    interval: '0 6 * * *'
    steps:
      - name: tap_google_analytics_target_athena
        cmd: 'meltano elt tap-google-analytics target-athena --job_id=ga_athena_hub_metrics'
        retries: 2
      - name: ge_raw_validate
        cmd: 'meltano test great_expectations:test_ga_raw'
        retries: 2
        depends_on:
          - tap_google_analytics_target_athena
      - name: dbt_google_analytics_run_stage
        cmd: 'meltano invoke dbt:run --models staging.google_analytics.*'
        retries: 2
        depends_on:
          - ge_raw_validate
  slack:
    interval: '0 6 * * *'
    steps:
      - name: tap_slack_target_athena
        cmd: 'meltano elt tap-slack target-athena-slack --job_id=tap_slack_target_athena'
        retries: 2
      - name: dbt_slack_run_stage
        cmd: 'meltano invoke dbt:run --models staging.slack.*'
        retries: 2
        depends_on:
          - tap_slack_target_athena
      - name: dbt_slack_test_stage
        cmd: 'meltano invoke dbt:test --models staging.slack.*'
        retries: 2
        depends_on:
          - dbt_slack_run_stage
  gitlab:
    interval: '0 6 * * *'
    steps:
      - name: tap_gitlab_target_athena
        cmd: 'meltano elt tap-gitlab target-athena-gitlab --job_id=tap_gitlab_target_athena'
        retries: 2
      - name: dbt_gitlab_run_models
        cmd: 'meltano invoke dbt:run --models staging.gitlab.*'
        retries: 2
        depends_on:
          - tap_gitlab_target_athena
      - name: dbt_gitlab_test_models
        cmd: 'meltano invoke dbt:test --models staging.gitlab.*'
        retries: 2
        depends_on:
          - dbt_gitlab_run_models
  github:
    interval: '0 6 * * *'
    steps:
      - name: tap_github_target_athena
        cmd: 'meltano elt tap-github target-athena-github --job_id=tap_github_target_athena'
        retries: 2
      - name: dbt_github_run_models
        cmd: 'meltano invoke dbt:run --models staging.github.*'
        retries: 2
        depends_on:
          - tap_github_target_athena
      - name: dbt_github_test_models
        cmd: 'meltano invoke dbt:test --models staging.github.*'
        retries: 2
        depends_on:
          - dbt_github_run_models
