with reparse_1 as (
    -- Incident: new schema not registered to SnowcatCloud versions 2.14.0 and 2.15.0 (partial)
    -- Related issues: https://github.com/meltano/meltano/pull/7179 and https://github.com/meltano/meltano/pull/7256
    SELECT
        payload_enriched,
        uploaded_at
    FROM {{ ref('stg_snowplow__events_bad') }}
    WHERE uploaded_at::date between '2023-01-17' AND '2023-02-02'
    AND failure_message[0]:schemaKey::STRING = 'iglu:com.meltano/environment_context/jsonschema/1-2-0'

)

{% for cte_name in ['reparse_1'] %}
    {%- if not loop.first %}
    UNION ALL
    {% endif -%}
    SELECT
        PARSE_JSON(payload_enriched):app_id::STRING AS app_id,
        PARSE_JSON(payload_enriched):platform::STRING AS platform,
        PARSE_JSON(payload_enriched):etl_tstamp::STRING AS etl_tstamp,
        PARSE_JSON(payload_enriched):collector_tstamp::STRING AS collector_tstamp,
        PARSE_JSON(payload_enriched):dvce_created_tstamp::STRING AS dvce_created_tstamp,
        PARSE_JSON(payload_enriched):event::STRING AS event,
        PARSE_JSON(payload_enriched):event_id::STRING AS event_id,
        PARSE_JSON(payload_enriched):txn_id::STRING AS txn_id,
        PARSE_JSON(payload_enriched):name_tracker::STRING AS name_tracker,
        PARSE_JSON(payload_enriched):v_tracker::STRING AS v_tracker,
        PARSE_JSON(payload_enriched):v_collector::STRING AS v_collector,
        PARSE_JSON(payload_enriched):v_etl::STRING AS v_etl,
        PARSE_JSON(payload_enriched):user_id::STRING AS user_id,
        PARSE_JSON(payload_enriched):user_ipaddress::STRING AS user_ipaddress,
        PARSE_JSON(payload_enriched):user_fingerprint::STRING AS user_fingerprint,
        PARSE_JSON(payload_enriched):domain_userid::STRING AS domain_userid,
        PARSE_JSON(payload_enriched):domain_sessionidx::STRING AS domain_sessionidx,
        PARSE_JSON(payload_enriched):network_userid::STRING AS network_userid,
        PARSE_JSON(payload_enriched):geo_country::STRING AS geo_country,
        PARSE_JSON(payload_enriched):geo_region::STRING AS geo_region,
        PARSE_JSON(payload_enriched):geo_city::STRING AS geo_city,
        PARSE_JSON(payload_enriched):geo_zipcode::STRING AS geo_zipcode,
        PARSE_JSON(payload_enriched):geo_latitude::STRING AS geo_latitude,
        PARSE_JSON(payload_enriched):geo_longitude::STRING AS geo_longitude,
        PARSE_JSON(payload_enriched):geo_region_name::STRING AS geo_region_name,
        PARSE_JSON(payload_enriched):ip_isp::STRING AS ip_isp,
        PARSE_JSON(payload_enriched):ip_organization::STRING AS ip_organization,
        PARSE_JSON(payload_enriched):ip_domain::STRING AS ip_domain,
        PARSE_JSON(payload_enriched):ip_netspeed::STRING AS ip_netspeed,
        PARSE_JSON(payload_enriched):page_url::STRING AS page_url,
        PARSE_JSON(payload_enriched):page_title::STRING AS page_title,
        PARSE_JSON(payload_enriched):page_referrer::STRING AS page_referrer,
        PARSE_JSON(payload_enriched):page_urlscheme::STRING AS page_urlscheme,
        PARSE_JSON(payload_enriched):page_urlhost::STRING AS page_urlhost,
        PARSE_JSON(payload_enriched):page_urlport::STRING AS page_urlport,
        PARSE_JSON(payload_enriched):page_urlpath::STRING AS page_urlpath,
        PARSE_JSON(payload_enriched):page_urlquery::STRING AS page_urlquery,
        PARSE_JSON(payload_enriched):page_urlfragment::STRING AS page_urlfragment,
        PARSE_JSON(payload_enriched):refr_urlscheme::STRING AS refr_urlscheme,
        PARSE_JSON(payload_enriched):refr_urlhost::STRING AS refr_urlhost,
        PARSE_JSON(payload_enriched):refr_urlport::STRING AS refr_urlport,
        PARSE_JSON(payload_enriched):refr_urlpath::STRING AS refr_urlpath,
        PARSE_JSON(payload_enriched):refr_urlquery::STRING AS refr_urlquery,
        PARSE_JSON(payload_enriched):refr_urlfragment::STRING AS refr_urlfragment,
        PARSE_JSON(payload_enriched):refr_medium::STRING AS refr_medium,
        PARSE_JSON(payload_enriched):refr_source::STRING AS refr_source,
        PARSE_JSON(payload_enriched):refr_term::STRING AS refr_term,
        PARSE_JSON(payload_enriched):mkt_medium::STRING AS mkt_medium,
        PARSE_JSON(payload_enriched):mkt_source::STRING AS mkt_source,
        PARSE_JSON(payload_enriched):mkt_term::STRING AS mkt_term,
        PARSE_JSON(payload_enriched):mkt_content::STRING AS mkt_content,
        PARSE_JSON(payload_enriched):mkt_campaign::STRING AS mkt_campaign,
        PARSE_JSON(payload_enriched):contexts::STRING AS contexts,
        PARSE_JSON(payload_enriched):se_category::STRING AS se_category,
        PARSE_JSON(payload_enriched):se_action::STRING AS se_action,
        PARSE_JSON(payload_enriched):se_label::STRING AS se_label,
        PARSE_JSON(payload_enriched):se_property::STRING AS se_property,
        PARSE_JSON(payload_enriched):se_value::STRING AS se_value,
        PARSE_JSON(payload_enriched):unstruct_event::STRING AS unstruct_event,
        PARSE_JSON(payload_enriched):tr_orderid::STRING AS tr_orderid,
        PARSE_JSON(payload_enriched):tr_affiliation::STRING AS tr_affiliation,
        PARSE_JSON(payload_enriched):tr_total::STRING AS tr_total,
        PARSE_JSON(payload_enriched):tr_tax::STRING AS tr_tax,
        PARSE_JSON(payload_enriched):tr_shipping::STRING AS tr_shipping,
        PARSE_JSON(payload_enriched):tr_city::STRING AS tr_city,
        PARSE_JSON(payload_enriched):tr_state::STRING AS tr_state,
        PARSE_JSON(payload_enriched):tr_country::STRING AS tr_country,
        PARSE_JSON(payload_enriched):ti_orderid::STRING AS ti_orderid,
        PARSE_JSON(payload_enriched):ti_sku::STRING AS ti_sku,
        PARSE_JSON(payload_enriched):ti_name::STRING AS ti_name,
        PARSE_JSON(payload_enriched):ti_category::STRING AS ti_category,
        PARSE_JSON(payload_enriched):ti_price::STRING AS ti_price,
        PARSE_JSON(payload_enriched):ti_quantity::STRING AS ti_quantity,
        PARSE_JSON(payload_enriched):pp_xoffset_min::STRING AS pp_xoffset_min,
        PARSE_JSON(payload_enriched):pp_xoffset_max::STRING AS pp_xoffset_max,
        PARSE_JSON(payload_enriched):pp_yoffset_min::STRING AS pp_yoffset_min,
        PARSE_JSON(payload_enriched):pp_yoffset_max::STRING AS pp_yoffset_max,
        PARSE_JSON(payload_enriched):useragent::STRING AS useragent,
        PARSE_JSON(payload_enriched):br_name::STRING AS br_name,
        PARSE_JSON(payload_enriched):br_family::STRING AS br_family,
        PARSE_JSON(payload_enriched):br_version::STRING AS br_version,
        PARSE_JSON(payload_enriched):br_type::STRING AS br_type,
        PARSE_JSON(payload_enriched):br_renderengine::STRING AS br_renderengine,
        PARSE_JSON(payload_enriched):br_lang::STRING AS br_lang,
        PARSE_JSON(payload_enriched):br_features_pdf::STRING AS br_features_pdf,
        PARSE_JSON(payload_enriched):br_features_flash::STRING AS br_features_flash,
        PARSE_JSON(payload_enriched):br_features_java::STRING AS br_features_java,
        PARSE_JSON(payload_enriched):br_features_director::STRING AS br_features_director,
        PARSE_JSON(payload_enriched):br_features_quicktime::STRING AS br_features_quicktime,
        PARSE_JSON(payload_enriched):br_features_realplayer::STRING AS br_features_realplayer,
        PARSE_JSON(payload_enriched):br_features_windowsmedia::STRING AS br_features_windowsmedia,
        PARSE_JSON(payload_enriched):br_features_gears::STRING AS br_features_gears,
        PARSE_JSON(payload_enriched):br_features_silverlight::STRING AS br_features_silverlight,
        PARSE_JSON(payload_enriched):br_cookies::STRING AS br_cookies,
        PARSE_JSON(payload_enriched):br_colordepth::STRING AS br_colordepth,
        PARSE_JSON(payload_enriched):br_viewwidth::STRING AS br_viewwidth,
        PARSE_JSON(payload_enriched):br_viewheight::STRING AS br_viewheight,
        PARSE_JSON(payload_enriched):os_name::STRING AS os_name,
        PARSE_JSON(payload_enriched):os_family::STRING AS os_family,
        PARSE_JSON(payload_enriched):os_manufacturer::STRING AS os_manufacturer,
        PARSE_JSON(payload_enriched):os_timezone::STRING AS os_timezone,
        PARSE_JSON(payload_enriched):dvce_type::STRING AS dvce_type,
        PARSE_JSON(payload_enriched):dvce_ismobile::STRING AS dvce_ismobile,
        PARSE_JSON(payload_enriched):dvce_screenwidth::STRING AS dvce_screenwidth,
        PARSE_JSON(payload_enriched):dvce_screenheight::STRING AS dvce_screenheight,
        PARSE_JSON(payload_enriched):doc_charset::STRING AS doc_charset,
        PARSE_JSON(payload_enriched):doc_width::STRING AS doc_width,
        PARSE_JSON(payload_enriched):doc_height::STRING AS doc_height,
        PARSE_JSON(payload_enriched):tr_currency::STRING AS tr_currency,
        PARSE_JSON(payload_enriched):tr_total_base::STRING AS tr_total_base,
        PARSE_JSON(payload_enriched):tr_tax_base::STRING AS tr_tax_base,
        PARSE_JSON(payload_enriched):tr_shipping_base::STRING AS tr_shipping_base,
        PARSE_JSON(payload_enriched):ti_currency::STRING AS ti_currency,
        PARSE_JSON(payload_enriched):ti_price_base::STRING AS ti_price_base,
        PARSE_JSON(payload_enriched):base_currency::STRING AS base_currency,
        PARSE_JSON(payload_enriched):geo_timezone::STRING AS geo_timezone,
        PARSE_JSON(payload_enriched):mkt_clickid::STRING AS mkt_clickid,
        PARSE_JSON(payload_enriched):mkt_network::STRING AS mkt_network,
        PARSE_JSON(payload_enriched):etl_tags::STRING AS etl_tags,
        PARSE_JSON(payload_enriched):dvce_sent_tstamp::STRING AS dvce_sent_tstamp,
        PARSE_JSON(payload_enriched):refr_domain_userid::STRING AS refr_domain_userid,
        PARSE_JSON(payload_enriched):refr_dvce_tstamp::STRING AS refr_dvce_tstamp,
        PARSE_JSON(payload_enriched):derived_contexts::STRING AS derived_contexts,
        PARSE_JSON(payload_enriched):domain_sessionid::STRING AS domain_sessionid,
        PARSE_JSON(payload_enriched):derived_tstamp::STRING AS derived_tstamp,
        PARSE_JSON(payload_enriched):event_vendor::STRING AS event_vendor,
        PARSE_JSON(payload_enriched):event_name::STRING AS event_name,
        PARSE_JSON(payload_enriched):event_format::STRING AS event_format,
        PARSE_JSON(payload_enriched):event_version::STRING AS event_version,
        PARSE_JSON(payload_enriched):event_fingerprint::STRING AS event_fingerprint,
        PARSE_JSON(payload_enriched):true_tstamp::STRING AS true_tstamp,
        uploaded_at
    FROM {{ cte_name }}
{% endfor %}